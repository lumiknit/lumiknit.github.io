import{d as N,n as P,o as ee,i as x,t as b,p as H,b as O,e as _,a as m,M as Y,z as k,y as be,k as je,l as A,s as j,m as ve,q as Ve,r as qe,A as yt,D as Q,F as te,f as $e,I as vt,S as mt,B as wt}from"./vendor-solid-js-MzRK2e14.js";import{F as Be}from"./vendor-@lumiknit-D9kEAVox.js";import{W as Ye,w as Ee,k as Ze,m as J,S as bt,Q as $t,t as St,e as xt,r as Ct,u as _t,a as Tt,s as Pt,i as Lt}from"./vendor-solid-tiny-color-ncoy5ZO_.js";import{t as I,T as Mt}from"./vendor-solid-toast-CFxGQc_T.js";import{T as kt,a as Ke,I as Dt,b as Rt,c as It,d as Bt,e as Et,f as Ot,g as At,h as Ft,i as Xe,j as zt,k as Ht,l as Nt,m as Gt,n as Ut,o as jt,p as Vt,q as qt,r as Yt,s as Zt,t as Kt,u as Xt,v as Wt}from"./vendor-solid-icons-BfhmdyKR.js";import{c as Jt,D as Qt,S as er,a as tr,b as rr,d as sr,u as or}from"./vendor-@thisbeyond-DD3vKpwz.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function r(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(o){if(o.ep)return;o.ep=!0;const n=r(o);fetch(o.href,n)}})();var nr=b("<div><button>");const ar=e=>{const[t,r]=P(-1),s=async()=>{const[o]=await Be.openIDBStores("test",["test"],"readwrite"),n=t()+1;await o.put(n,"cnt"),r(n)};return ee(async()=>{const[o]=await Be.openIDBStores("test",["test"],"readwrite"),n=await o.get("cnt");n===void 0?(await o.put(0,"cnt"),r(0)):r(n)}),(()=>{var o=nr(),n=o.firstChild;return n.$$click=s,x(n,t),o})()};N(["click"]);const ir=e=>({...e,canvasPenAction:e.canvasClickAction==="move"?"move":"draw",canvasTouchAction:e.canvasClickAction==="draw"?"draw":"move",brushFollowFactor:Math.pow(.99,e.brushStabilization||0),maxHistory:Math.max(e.maxHistory||100,8),bgCheckerboard:e.bgCheckerboard||{color1:[112,112,112],color2:[156,156,156],size:32}}),V=(e,t)=>{const s=new OffscreenCanvas(e,t).getContext("2d");if(!s)throw new Error("Failed to get 2d context");return s},lr=e=>({width:e.canvas.width,height:e.canvas.height}),Se=(e,t)=>{const r=V(t.width,t.height);return r.drawImage(e.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),r},We=(e,t,r,s)=>{e.save(),e.globalCompositeOperation="source-over",e.clearRect(r,s,t.canvas.width,t.canvas.height),e.drawImage(t.canvas,r,s),e.restore()},Je=(e,t,r)=>{const s=e.canvas;return s instanceof HTMLCanvasElement?new Promise(o=>{s.toBlob(n=>{if(!n)throw new Error("Failed to convert canvas to blob");o(n)},t,r)}):s.convertToBlob({type:t,quality:r})},cr=async e=>{const t=await Je(e,"image/png"),r=new Uint8Array(await t.arrayBuffer());return btoa(String.fromCharCode(...r))},ur=async e=>{const t=new Image;t.src=`data:image/png;base64,${e}`,await t.decode();const r=V(t.width,t.height);return r.drawImage(t,0,0),r},ie=(e,t,r,s)=>new Uint8ClampedArray([e,t,r,s]),Z=e=>`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]/255})`,dr=e=>({shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey,meta:e.metaKey});class xe{value;constructor(t){this.value=t}app(t){return new xe(t(this.value))}}const z={x:0,y:0},Ce=(e,t)=>({x:e.x+t.x,y:e.y+t.y}),me=(e,t,r)=>({x:e.x*(1-r)+t.x*r,y:e.y*(1-r)+t.y*r}),U=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),re=(e,t,r,s)=>({x:r*(e*s.x-t*s.y),y:r*(t*s.x+e*s.y)}),_e=(e,t,r)=>re(Math.cos(e),Math.sin(e),t,r),hr=e=>({x:e.x+e.width/2,y:e.y+e.height/2}),X={left:1/0,right:-1/0,top:1/0,bottom:-1/0},fr=(e,t,r,s)=>(e.left=Math.min(e.left,t-s),e.right=Math.max(e.right,t+s),e.top=Math.min(e.top,r-s),e.bottom=Math.max(e.bottom,r+s),e),le=(e,t,r)=>(e.left=Math.min(e.left,t),e.right=Math.max(e.right,t+1),e.top=Math.min(e.top,r),e.bottom=Math.max(e.bottom,r+1),e),pr=(e,t)=>(e.left=Math.min(e.left,t.x),e.right=Math.max(e.right,t.x+t.width),e.top=Math.min(e.top,t.y),e.bottom=Math.max(e.bottom,t.y+t.height),e),gr=(e,t,r)=>({left:Math.max(0,e.left),right:Math.min(t,e.right),top:Math.max(0,e.top),bottom:Math.min(r,e.bottom)}),Te=e=>({x:e.left,y:e.top,width:e.right-e.left,height:e.bottom-e.top}),yr=()=>{const e=Date.now().toString(36),t=Math.random().toString(36).slice(2);return`${e}-${t}`},Qe=(e,t,r)=>({id:yr(),name:e,off:{...z},visible:!0,opacity:1,data:V(t,r)}),vr=(e,t)=>{const r=t.getImageData(0,0,t.canvas.width,t.canvas.height);let s={...X};for(let o=0;o<r.height;o++)for(let n=0;n<r.width;n++){const a=(o*r.width+n)*4;r.data[a+3]>0&&le(s,n,o)}s.left>=s.right||s.top>=s.bottom?(e.off={...z},e.data=V(1,1)):(e.off={x:s.left,y:s.top},e.data=V(s.right-s.left,s.bottom-s.top),e.data.drawImage(t.canvas,-s.left,-s.top))},ce=(e,t,r,s,o)=>{if(!t.visible||t.opacity<=0)return;let n=0,a=0;o||(n=t.off.x,a=t.off.y),e.save(),e.globalAlpha=t.opacity,e.drawImage((o||t.data).canvas,n+r,a+s),e.restore()},et=e=>{const t={points:e,bd:{...X}};for(const[r,s]of e)fr(t.bd,r,s,0);return t},mr=e=>{if(!e.path2D){const t=new Path2D,[r,s]=e.points[0];t.moveTo(r,s);for(let o=1;o<e.points.length;o++){const[n,a]=e.points[o];t.lineTo(n,a)}t.closePath(),e.path2D=t}return e.path2D},wr=e=>(e.svg||(e.svg=e.points.map(([t,r])=>`${t},${r}`).join(" ")),e.svg),br=(e,t)=>{const r=[],s=[],o=e.length/2;r.push([e[0],t]),s.push([e[1],t]);let n=e[0],a=e[1];for(let i=1;i<o;i++){const d=e[i*2],f=e[i*2+1];n!=d&&(r.push([n,t+i],[d,t+i]),n=d),a!=f&&(s.push([a,t+i],[f,t+i]),a=f)}return r.push([n,t+o]),s.push([a,t+o]),s.reverse(),et(r.concat(s))},$r=(e,t,r,s)=>et([[e,t],[e+r,t],[e+r,t+s],[e,t+s]]),tt=(e,t)=>{const r=[],s=(t-1)/2,o=e/2-.1,n=t/2-.1,a=e%2;for(let d=0;d<n;d++){const f=(d-s)/n,u=Math.sqrt(1-f*f)*o;r.push(Math.round(u+a/2)*2-a)}const i=r.slice(0,r.length-t%2);return i.reverse(),r.concat(i)},rt=(e,t,r,s)=>{const o=tt(r,s),n=[];for(let a=0;a<o.length;a++){const i=r-o[a];n.push(e+i/2,e+r-i/2)}return br(n,t)},K=new Map,Sr=(e,t,r,s,o,n,a)=>{const i=(o-1)/2;e=Math.floor(e-i),t=Math.floor(t-i),r=Math.floor(r-i),s=Math.floor(s-i);const d=n==="round"?o:-o;K.has(d)||(K.size>16&&K.delete(K.keys().next().value),K.set(d,d>0?tt(o,o):Array(Math.round(o)).fill(o)));const f=K.get(d);let u=Math.abs(r-e),h=Math.abs(s-t),$=a;h>u&&([e,t,r,s]=[t,e,s,r],[u,h]=[h,u],$=(C,T,L,R)=>a(T,C,R,L));const y=h/u;if(e>r&&([e,r,t,s]=[r,e,s,t]),t===s){if(n==="square")$(e,t,r+o-e,o);else for(let C=0;C<o;C++){const T=f[C],L=e+(o-T)/2;$(L,t+C,u+T,1)}return}const v=Math.sign(s-t);let l=0,c=0;{let C=-1/0;for(let T=0;T<o/2;T++){const L=(o+f[T])/2-1,R=y*L-T;R>C&&(C=R,l=L,c=T)}}const g=o-1-c;let p=0,w=0,S=.5-y,D=.5-y;const M=v>0?t:t+o-1;for(let C=0;C<o+h;C++){const T=C-h,L=f[C],R=f[T];if(C<=g)w=e+(o-L)/2;else if(T>g)w=r+(o-R)/2;else{const B=1+Math.max(0,Math.ceil(D/y));w+=B,D+=1-B*y}if(C<c)p=e+(o+L)/2;else if(T>=c)p=r+(o+R)/2;else{C===c&&(p=e+l);const B=1+Math.max(0,Math.ceil(S/y));p+=B,S+=1-B*y}$(w,M+v*C,p-w,1)}},xr=e=>{const[t,r]=P(new Map,{equals:!1});return Object.assign(e,{brushSet:t,setBrushSet:r})},st=(e,t,r,s)=>{const o=Math.floor(r/2),n=s?rt(-o,-o,r,r):$r(-o,-o,r,r);let a;return e.setBrushSet(i=>(a={...i.get(t),shape:n,size:r,round:s},i.set(t,a))),a},Cr=(e,t,r)=>{e.setBrushSet(s=>{const o=s.get(t);return s.set(t,{...o,spoidLocal:r})})},Oe=(e,t,r,s)=>{e.setBrushSet(o=>{const n=o.get(t);return o.set(t,{...n,text:r??n.text,fontSize:s??n.fontSize})})},Pe=e=>Gr(e,e.belowLayerRef?.getContext("2d"),e.aboveLayerRef?.getContext("2d")),_r=e=>{const t=e.cursor(),r=E(e).size/2;return{x:Math.round(t.brush.x-r),y:Math.round(t.brush.y-r)}},Ae=e=>{if(!e.rootRef)return!1;const t=e.cursor().brush,r=Er(e,t),s=e.rootRef.getBoundingClientRect();return r.x<0||r.y<0||r.x>s.width||r.y>s.height},Tr=e=>{if(!e.rootRef)return!1;const t=e.rootRef.getBoundingClientRect(),r=ae(e,hr(t));e.setCursor({real:r,brush:r})},E=e=>{const t=e.toolType();let r=e.brushSet().get(t);return r||(r=st(e,t,1,!0)),r},Pr=(e,t)=>{H(()=>{e.setToolType(t);const s=pe.has(t);e.setShowFocusedLayer(!s)});const r=e.size();W(e,{...z,...r})},Lr=(e,t,r)=>{const s=e.toolType();return st(e,s,t,r)},se=(e,t)=>{switch(e.toolType()){case"brush":case"text":t.strokeStyle=t.fillStyle=Z(e.palette().current),t.globalCompositeOperation="source-over";break;case"select":t.strokeStyle=t.fillStyle=Z(ie(255,0,0,255)),t.globalCompositeOperation="source-over";break;case"eraser":case"deselect":t.strokeStyle=t.fillStyle=Z(ie(255,0,0,255)),t.globalCompositeOperation="destination-out";break}},ue=(e,t,r,s)=>{const o=e.size();s||(s={x:o.width/2,y:o.height/2});const n=e.zoom(),a=e.angle(),i=n*r,d=a.rad+t,f=Math.cos(d),u=Math.sin(d),h=_e(a.rad,n,s),$=re(f,u,i,s);H(()=>{e.setZoom(i),e.setAngle({rad:d,cos:f,sin:u}),e.setScroll(y=>({x:y.x+h.x-$.x,y:y.y+h.y-$.y}))})},W=(e,t)=>{const r=e.toolType(),s=q(e);if(s.clearRect(t.x,t.y,t.width,t.height),pe.has(r)){const o=F(e),n=s.globalCompositeOperation;s.globalCompositeOperation="source-over",s.drawImage(o.canvas,t.x,t.y,t.width,t.height,t.x,t.y,t.width,t.height),s.globalCompositeOperation=n}},he=e=>{const t=e.layers(),r=e.focusedLayer(),s=F(e);vr(t[r],s)},fe=e=>{const t=e.layers(),r=e.focusedLayer(),s=F(e),o=t[r];s.save(),s.globalCompositeOperation="copy",s.drawImage(o.data.canvas,o.off.x,o.off.y),s.restore(),W(e,{...z,...e.size()}),Pe(e)},de=(e,t,r)=>{t<0||t>=e.layers().length||H(()=>{r||he(e),e.setFocusedLayer(t),fe(e)})},ot=(e,t)=>{let r,s=!1,o=!1;const n=e.focusedLayer();let a=n;return n===t&&(n+1<e.layers().length?a++:(n===0&&(nt(e,"Layer 0",0),o=!0,t++,a++,e.setFocusedLayer(t)),a--),de(e,a),s=!0,console.log("Focus changed",a,t)),e.setLayers(i=>([r]=i.splice(t,1),i)),a>n&&e.setFocusedLayer(a-1),Pe(e),[r,s,o]},Mr=e=>t=>{const r={...e},[s,o]=P(ir(e));return Object.assign(t,{originalConfig:r,config:s,setConfig:o})},Le=e=>{const t=e.config().bgCheckerboard;return Ye(Ee(t.color1),Ee(t.color2),t.size)},kr=e=>{const[t,r]=P({real:z,brush:z});return Object.assign(e,{cursor:t,setCursor:r})},Dr=(e,t)=>{e.setCursor(r=>({...r,real:{...t},brush:{...t}}))},Rr=(e,t)=>{e.setCursor(r=>({...r,real:{...t}}))},Ir=(e,t)=>{e.setCursor(r=>({...r,real:Ce(r.real,t)}))},Br=e=>{const[t,r]=P({...z}),[s,o]=P(8),[n,a]=P({rad:0,cos:1,sin:0});return Object.assign(e,{scroll:t,setScroll:r,zoom:s,setZoom:o,angle:n,setAngle:a,savedScroll:t(),savedZoom:s(),savedAngle:n()})},ae=(e,t)=>{const r=e.angle();return re(r.cos,-r.sin,1/e.zoom(),U(t,e.scroll()))},Er=(e,t)=>{const r=e.angle();return Ce(re(r.cos,r.sin,e.zoom(),t),e.scroll())},Or=(e,t,r)=>{const s=e.size(),o=Math.min(t/s.width,r/s.height)*.95,n=(t-o*s.width)/2,a=(r-o*s.height)/2;H(()=>{e.setZoom(o),e.setScroll({x:n,y:a})})},Ar=e=>{e.savedScroll={...e.scroll()},e.savedZoom=e.zoom(),e.savedAngle={...e.angle()}},Fr=e=>{H(()=>{e.setScroll(e.savedScroll),e.setZoom(e.savedZoom),e.setAngle(e.savedAngle)})},zr=(e,t,r,s)=>{t<=0&&(t=1),H(()=>{e.setAngle(o=>{const n=o.rad+r;return{rad:n,cos:Math.cos(n),sin:Math.sin(n)}}),e.setZoom(o=>o*t),e.setScroll(o=>Ce(s,_e(r,t,o)))})},Hr=(e,t)=>r=>{const[s,o]=P({width:e,height:t}),[n,a]=P([Qe("Layer 1",e,t)],{equals:!1}),[i,d]=P(0);return Object.assign(r,{name:"",size:s,setSize:o,layers:n,setLayers:a,focusedLayer:i,setFocusedLayer:d})},Nr=(e,t)=>{const r=e.size(),s=V(r.width,r.height);for(let n=0;n<e.layers().length;n++)ce(s,e.layers()[n],0,0);if(t=Math.min(1,Math.floor(t)),t<=1)return s;const o=V(r.width*t,r.height*t);return o.scale(t,t),o.imageSmoothingEnabled=!1,o.imageSmoothingQuality="low",o.drawImage(s.canvas,0,0),o},Gr=(e,t,r)=>{const s=e.size();t.clearRect(0,0,s.width,s.height),t.globalCompositeOperation="source-over";const o=e.layers(),n=e.focusedLayer();for(let a=0;a<n;a++)console.log("Render below",a,o[a]),ce(t,o[a],0,0);r.clearRect(0,0,s.width,s.height),r.globalCompositeOperation="source-over";for(let a=n+1;a<o.length;a++)console.log("Render above",a),ce(r,o[a],0,0)},nt=(e,t,r)=>(H(()=>{const s=e.layers();(r<0||r>=s.length)&&(r=s.length);const o=Qe(t,1,1);s.splice(r,0,o),e.setLayers(s)}),r),Ur=e=>{const t=ie(255,255,255,255),[r,s]=P({current:t,hsv:[0,0,1],history:[t]});return Object.assign(e,{palette:r,setPalette:s})},at=e=>{const t=new Uint32Array(e.buffer);return r=>{const s=new Uint32Array(r.buffer);return t[0]!==s[0]}},it=(e,t)=>{const r=Ze([t[0],t[1],t[2]]);e.setPalette(s=>({current:t,hsv:r,history:[...s.history.filter(at(t)),t]}))},jr=(e,t,r)=>{const s=J(t);e.setPalette(o=>{r??=o.current[3];const n=ie(s[0],s[1],s[2],r);return{current:n,hsv:t,history:[...o.history.filter(at(n)),n]}})};class Vr{maxHistory;cleanThreshold=8;history=[];futures=[];historySize;setHistorySize;onExec;onRevert;constructor(t,r,s){this.maxHistory=t,this.onRevert=r,this.onExec=s,[this.historySize,this.setHistorySize]=P([0,0])}push(t){this.history.push(t),this.history.length>this.maxHistory+this.cleanThreshold&&this.history.splice(0,this.history.length-this.maxHistory),this.futures=[],this.setHistorySize([this.history.length,0])}exec(t){const r=[];for(const s of t){const o=this.onExec(s);r.push(o||s)}this.history.push(r),this.futures=[],this.setHistorySize([this.history.length,0])}undo(){const t=this.history.pop();if(!t)return!1;for(let r=t.length-1;r>=0;r--)this.onRevert(t[r]);return this.futures.push(t),this.setHistorySize([this.history.length,this.futures.length]),!0}redo(){const t=this.futures.pop();if(!t)return!1;const r=[];for(const s of t){const o=this.onExec(s);r.push(o||s)}return this.history.push(r),this.setHistorySize([this.history.length,this.futures.length]),!0}}const qr=(e,t)=>{switch(t.type){case"updateImg":const r=F(e),{rect:s,newImg:o}=t;if(!o){I.error("Unknown error"),console.error("exec failed: newImg is not set.");return}return We(r,o,s.x,s.y),W(e,s),t;case"newLayer":nt(e,t.name,t.index),I.success(`New layer ${t.name} is created`);break;case"deleteLayer":{const[n,a,i]=ot(e,t.index);return t.layer=n,t.focusChanged=a,t.createdEmpty=i,I.success(`Layer ${n.name} is deleted`),t}case"focusLayer":t.oldIndex??=e.focusedLayer(),de(e,t.index);break;case"changeCanvasSize":he(e),H(()=>{t.prev||(t.prev={...e.size()}),t.oldLayers||(t.oldLayers=[...e.layers()]),t.newLayers||(t.newLayers=t.oldLayers.map(n=>{const a=Se(F(e),{x:0,y:0,width:t.next.width,height:t.next.height});return{...n,ctx:a}})),e.setSize(t.next),e.setLayers(t.newLayers)}),fe(e);break;default:throw new Error(`Unknown action type to execute: ${t.type}`)}},Yr=(e,t)=>{switch(t.type){case"updateImg":const r=F(e),{rect:s,oldImg:o}=t;if(!o){I.error("Unknown error"),console.error("revert failed: oldImg is not set.");return}return t.newImg??=Se(r,s),We(r,o,s.x,s.y),W(e,s),t;case"newLayer":ot(e,t.index),I.success(`Layer ${t.name} is deleted`);break;case"deleteLayer":e.setLayers(n=>(console.log(t.layer),n.splice(t.index,t.createdEmpty?1:0,t.layer),console.log(t,n),n)),t.focusChanged?de(e,t.index,!0):e.focusedLayer()>=t.index&&e.setFocusedLayer(n=>n+1),I.success(`Layer ${t.layer.name} is restored`);break;case"focusLayer":de(e,t.oldIndex);break;case"changeCanvasSize":console.log("changeCanvasSize"),H(()=>{e.setSize(t.prev),e.setLayers(t.oldLayers)}),fe(e),console.log(e.size(),e.layers());break;default:throw new Error(`Unknown action type to revert: ${t.type}`)}},Zr=(e,t)=>{const r=e.focusedLayer()+1;e.history.exec([{type:"newLayer",name:t,index:r},{type:"focusLayer",index:r}])},Kr=(e,t)=>{e.history.exec([{type:"deleteLayer",index:t}])},Xr=(e,t)=>{e.history.exec([{type:"focusLayer",index:t}])},Me=e=>{const t=e.tempBd;W(e,Te(t)),e.tempBd={...X}},lt=(e,t,r,s,o,n)=>{const a=E(e);Sr(r,s,o,n,a.size,a.round?"round":"square",(i,d,f,u)=>{t.fillRect(i,d,f,u),pr(e.tempBd,{x:i,y:d,width:f,height:u})})},Wr=(e,t,r,s)=>{const o=e.drawState(),n=q(e);o.last;const a=Math.floor(o.last.x),i=Math.floor(o.last.y),d=t-a-.5,f=r-i-.5;!s&&d*d+f*f<1.4||(o.last={x:t,y:r},n.save(),se(e,n),lt(e,n,a,i,t,r),n.restore())},ge=(e,t,r,s)=>{const o=e.drawState(),n=o.start,a=o.last,i=Math.floor(n.x),d=Math.floor(n.y),f=Math.floor(a.x),u=Math.floor(a.y),h=Math.floor(t.x),$=Math.floor(t.y);if(h===f&&$===u)return;const y=q(e);Me(e),y.save(),se(e,y);const v=e.tempBd;if(le(v,i,d),le(v,h,$),r){if(s){const l=rt(v.left,v.top,v.right-v.left,v.bottom-v.top);y.clip(mr(l))}y.fillRect(v.left,v.top,v.right-v.left,v.bottom-v.top)}else{const l=E(e),c=l.size;y.lineWidth=c;const g=c/2-Math.floor(c/2);y.strokeRect(v.left+g,v.top+g,v.right-v.left-1,v.bottom-v.top-1),v.left-=c,v.right+=c,v.top-=c,v.bottom+=c}y.restore(),o.last={...t}},Jr=(e,t)=>{const r=e.drawState(),s=r.start,o=r.last,n=Math.round(o.x*2),a=Math.round(o.y*2),i=Math.round(t.x*2),d=Math.round(t.y*2);if(i===n&&d===a)return;Me(e);const f=q(e);f.save(),se(e,f),lt(e,f,s.x,s.y,t.x,t.y),f.restore(),r.last={...t}},Qr=(e,t,r)=>{const s=e.drawState(),o=e.toolType();if(s.last.x<0)return;const n=[Math.floor(t.x),Math.floor(t.y)];if(n[0]<0||n[0]>=e.size().width||n[1]<0||n[1]>=e.size().height)return;const a=pe.has(o)?q(e):F(e),i=a.getImageData(0,0,e.size().width,e.size().height),d=i.width,f=i.height,u=new Uint8Array(d*f),h=(l,c)=>[0,1,2,3].reduce((p,w)=>p+(l[w]-c[w])**2,0)/4<=r,$=a.getImageData(t.x,t.y,1,1).data;let y={...X};for(;n.length>0;){const l=n.pop(),c=n.pop(),g=(l*d+c)*4;if(!(c<0||c>=d||l<0||l>=f||u[l*d+c]>0)){if(!h(i.data.slice(g,g+4),$)){u[l*d+c]=1;continue}u[l*d+c]=255,le(y,c,l),n.push(c-1,l),n.push(c+1,l),n.push(c,l-1),n.push(c,l+1)}}const v=q(e);v.save(),se(e,v);for(let l=0;l<f;l++)for(let c=0;c<d;c++)u[l*d+c]>127&&v.fillRect(c,l,1,1);v.restore(),e.tempBd=y,s.last={x:-1,y:-1}},es=(e,t)=>{const r=e.cursor().brush;switch(e.drawShape()){case"free":Wr(e,r.x,r.y,t);break;case"rect":ge(e,r);break;case"fillRect":ge(e,r,!0);break;case"fillEllipse":ge(e,r,!0,!0);break;case"line":Jr(e,r);break;case"fill":Qr(e,r,1);break}},ts=(e,t)=>{const r=e.drawState(),s=e.cursor().real,o=r.last,n=Math.floor(s.x),a=Math.floor(s.y),i=Math.floor(o.x),d=Math.floor(o.y);if(!t&&n===i&&a===d)return;const f=E(e);let u;if(f.spoidLocal)u=F(e).getImageData(n,a,1,1).data;else{const h=V(1,1),$=e.focusedLayer();e.layers().forEach((y,v)=>{let l=v===$?F(e):y.data;ce(h,y,-n,-a,l)}),u=h.getImageData(0,0,1,1).data}r.color=u,t&&it(e,u)},Fe=new Map([[8,"Galmuri7"],[10,"Galmuri9"],[11,"Galmuri10"]]),rs=e=>{if(Fe.has(e))return Fe.get(e)},ss=(e,t)=>{const r=e.drawState(),s=e.cursor().real,o=Math.floor(s.x),n=Math.floor(s.y),a=r.last.x,i=r.last.y;if(!t&&o===a&&n===i)return;Me(e);const d=E(e),f=d.fontSize??10,u=rs(f)||"Galmuri9",h=q(e);h.save(),se(e,h),h.font=`${f}px ${u}`;const $=h.measureText(d.text);h.fillText(d.text,o,n),h.restore(),e.tempBd={left:o,top:n-($.actualBoundingBoxAscent+$.actualBoundingBoxDescent),right:o+$.width,bottom:n+1}},os=e=>{const[t,r]=P("free"),[s,o]=P("brush");return Object.assign(e,{drawShape:t,setDrawShape:r,toolType:s,setToolType:o})},ns=e=>{const[t,r]=P(!0);return Object.assign(e,{showFocusedLayer:t,setShowFocusedLayer:r})},q=e=>{if(!e.tempLayerRef)throw new Error("Temp layer ref is not set");const t=e.tempLayerRef.getContext("2d");if(!t)throw new Error("Failed to get temp layer context");return t},F=e=>{if(!e.focusedLayerRef)throw new Error("Focused layer ref is not set");const t=e.focusedLayerRef.getContext("2d");if(!t)throw new Error("Failed to get focused layer context");return t},as=e=>{const[t,r]=P();return Object.assign(e,{blocked:t,uiBlocked:r})},is=(e,t,r)=>{const s=new xe({}).app(Mr(e)).app(xr).app(kr).app(Br).app(Hr(t,r)).app(Ur).app(os).app(as).app(ns).value,[o,n]=P();return Object.assign(s,{history:new Vr(s.config().maxHistory,a=>Yr(s,a),a=>qr(s,a)),tempBd:{...X},lastStepMS:Date.now(),drawState:o,setDrawState:n})},ls=e=>{Pe(e),ct(e)},ct=e=>{const t=e.rootRef;Or(e,t.offsetWidth,t.offsetHeight)},cs=(e,t)=>{if(!e.drawState)e.setCursor(r=>({...r,brush:r.real}));else{const s=(1-e.config().brushFollowFactor)**(10*t/1e3);e.setCursor(o=>({...o,brush:me(o.real,o.brush,s)}))}},us=e=>{if(e.tempBd.left===1/0)return;const t=e.toolType(),r=q(e),s=F(e),o=e.size(),n=gr(e.tempBd,o.width,o.height),a=Te(n),i=Se(s,a);pe.has(t)&&s.clearRect(a.x,a.y,a.width,a.height),s.drawImage(r.canvas,a.x,a.y,a.width,a.height,a.x,a.y,a.width,a.height);const d={type:"updateImg",rect:a,oldImg:i};e.history.push([d]),W(e,a),e.tempBd={...X}},ds=e=>{e.history.undo()||I.error("Nothing to undo")},hs=e=>{e.history.redo()||I.error("Nothing to redo")},fs=(e,t)=>{e.history.exec(t)},ut=e=>{const t=e.cursor().brush;let r;switch(e.toolType()){case"brush":case"eraser":r=es;break;case"spoid":r=ts;break;case"text":r=ss;break;default:r=()=>{}}const s={step:r,start:{...t},last:{...t},color:e.palette().current,initColor:e.palette().current,tool:e.toolType()};e.setDrawState(s),r(e,!0)},dt=(e,t)=>{const r=e.drawState();r&&(r.step(e,!0),e.setDrawState(),gs.has(r.tool)&&us(e))},ps=e=>{const t=Date.now(),r=t-e.lastStepMS;e.lastStepMS=t,cs(e,r),e.drawState()?.step(e)},pe=new Set(["eraser","deselect"]),gs=new Set(["brush","eraser","text","transform"]),ys=new Set(["brush","eraser"]),ze=4,He=200,vs=500,ms=window.setTimeout,ws=window.clearTimeout,Ne={translate:{...z},scale:1,rotate:0},bs=e=>({...e,preventDefault:e.preventDefault??!0,pointers:new Map,typePointers:new Map(["P","T"].map(t=>[t,new Map]))}),Ge=e=>e.pointerType==="touch"?"T":"P",ye=e=>({x:e.clientX,y:e.clientY}),$s=(e,t)=>{const r={},s=(l,c)=>{try{const g=t[l];if(g)return g(c)!==!1}catch(g){console.warn("Error: "+l,t,g)}},o=(l,c)=>({id:l,timeStamp:c,pointers:t.pointers,modifiers:{},button:-1}),n=l=>({...l,...o(l.pointerId,l.timeStamp),modifiers:dr(l),type:Ge(l),pos:ye(l)}),a=(l,c)=>{const g=l.pos;l.pos=ye(c),l.delta=U(l.pos,g)},i=l=>{if(!t.gesture)return;const c=t.gesture;switch(c.type){case"D":s("onDragEnd",{...c,...o(l.id,Date.now()),pressure:0,tiltX:0,tiltY:0});break;case"p":s("onPinchEnd",{...c,...o(l.id,Date.now())});break}c.longPressTimeout!==void 0&&(ws(c.longPressTimeout),c.longPressTimeout=void 0),c.type="Z"},d=l=>()=>{if(!t.pointers.has(l)||t.gesture?.type!=="WT")return;const c=t.pointers.get(l),g={...o(c.id,c.timeStamp),count:t.gesture.maxPointers};s("onLongPress",g)&&i(c)},f=(l,c)=>t.gesture={type:l,downTS:c,maxPointers:t.pointers.size,...Ne},u=(l,c)=>{const g=t.typePointers.get(l.type).size,p=t.gesture??f("D",c.timeStamp);p.translate={...z},p.scale=1,p.rotate=0;const w={...c,...Ne,id:l.id};if(g===1){if(!s("onDragStart",w))return;p.type="D"}else{if(!s("onPinchStart",w))return;p.type="p"}p.ptrType=l.type,t.pointers.forEach(S=>{S.dragStartPos={...S.pos}})},h=l=>{const c=t.gesture,g=t.pointers.get(l.id);return c.translate=U(g.pos,g.dragStartPos),{...l,translate:{...c.translate}}},$=l=>{const c=t.gesture,g=Array.from(t.pointers.values()),p=g[0],w=g[1],S=p.dragStartPos,D=w.dragStartPos,M=p.pos,C=w.pos,T=U(S,D),L=U(M,C),R=me(S,D,.5),B=me(M,C,.5);return c.rotate=Math.atan2(L.y,L.x)-Math.atan2(T.y,T.x),c.scale=Math.hypot(L.y,L.x)/Math.hypot(T.y,T.x),c.translate=U(B,_e(c.rotate,c.scale,R)),{...l,translate:{...c.translate},scale:c.scale,rotate:c.rotate}},y=(l,c,g)=>{let p=!1;const w=t.gesture;if(w&&(!w.ptrType||w.ptrType===l.type)){const S=t.typePointers.get(l.type);switch(w.type){case"WT":if(g){i(l);return}t.pointers.size>1?c.timeStamp-(w.upTS||w.downTS)>He&&i(l):t.onTap&&s("onTap",{...c,count:w.maxPointers});break;case"p":if(S.size>2)break;p=!0;case"D":i(l);break}}if(t.pointers.delete(l.id),t.typePointers.get(l.type).delete(l.id),p){const S=t.typePointers.get(l.type).values().next().value;u(S,c)}t.pointers.size<=0&&(t.gesture=void 0)};r.pointerdown=l=>{const c=n(l);if(!s("onPointerDown",c))return;t.preventDefault&&l.preventDefault();const g=ye(l),p=Ge(l);let w=t.pointers.get(l.pointerId);w?w.buttons.add(l.button):(w={id:l.pointerId,pos:g,delta:{...z},timeStamp:l.timeStamp,initPos:{...g},dragStartPos:{...g},type:p,buttons:new Set([l.button])},t.pointers.set(l.pointerId,w),t.typePointers.get(p).set(l.pointerId,w),t.captureRef&&t.captureRef.setPointerCapture(l.pointerId));let S=t.gesture;if(!S)S=f("WT",l.timeStamp),t.onLongPress?S.longPressTimeout=ms(d(l.pointerId),vs):t.onTap||(u(w,c),w.moved=!0);else{switch(S.type){case"WT":(S.upTS||l.timeStamp-S.downTS>He)&&i(w);break;case"D":if(S.ptrType!==p)break;i(w),u(w,c);case"p":w.moved=!0;break}S.downTS=l.timeStamp,S.maxPointers=Math.max(S.maxPointers,t.pointers.size)}},r.pointermove=l=>{const c=n(l);s("onPointerMove",c),t.preventDefault&&l.preventDefault();const g=t.pointers.get(l.pointerId);if(!g)return;const p=t.gesture;if(a(g,l),!g.moved){const w=U(g.pos,g.initPos);g.moved=w.x*w.x+w.y*w.y>ze*ze}if(!(!p||!g.moved||p.ptrType!==g.type&&p.ptrType))switch(p.type){case"WT":u(g,c);break;case"D":s("onDragMove",h(c));break;case"p":s("onPinchMove",$(c));break}};const v=l=>c=>{const g=n(c);s(l?"onPointerCencel":"onPointerUp",g),t.preventDefault&&c.preventDefault();const p=t.pointers.get(c.pointerId);p&&(a(p,c),y(p,g,l))};r.pointerup=v(!1),r.pointercancel=v(!0);for(const l in r)e.addEventListener(l,r[l]),t.onWheel&&e.addEventListener("wheel",t.onWheel,{});return()=>{for(const l in r)e.removeEventListener(l,r[l]),t.onWheel&&e.removeEventListener("wheel",t.onWheel)}};var Ss=b("<div class=cv-real-cursor>"),xs=b("<div class=cv-cursor><svg><polygon>"),Cs=b('<svg viewBox="-1 -1 2 2"fill=none stroke-width=0.2><circle cx=0 cy=0 r=0.5 stroke=#000 stroke-width=0.225></circle><path d="M -0.5 0 A 0.5 0.5 0 0 0 0.5 0"></path><path d="M -0.5 0 A 0.5 0.5 0 0 1 0.5 0">');const _s=e=>{const t=()=>e.z.zoom(),r=O(()=>1/e.z.zoom()),s=O(()=>{const u=e.z.zoom();return u>16?4:u>8?2:1}),o=O(()=>{const u=s()/2;return`translate(-${u}px, -${u}px)`}),n=O(()=>{const u=e.z,h=u.zoom(),$=u.cursor(),y=Math.floor(h*$.real.x),v=Math.floor(h*$.real.y);return`translate(${y}px, ${v}px)`}),a=O(()=>{const u=_r(e.z),h=e.z.zoom();return`translate(${Math.floor(h*u.x)}px, ${Math.floor(h*u.y)}px)`}),i=O(()=>{const u=E(e.z).shape.bd;return u.right-u.left}),d=O(()=>{const u=E(e.z).shape.bd;return u.bottom-u.top}),f=O(()=>{const u=Te(E(e.z).shape.bd),h=s()*r()/2;return`${u.x-h} ${u.y-h} ${u.width+2*h} ${u.height+2*h}`});return[(()=>{var u=Ss();return u.style.setProperty("z-index","20"),_(h=>(h=n()+" translate(-50%, -50%)")!=null?u.style.setProperty("transform",h):u.style.removeProperty("transform")),u})(),m(be,{get children(){return[m(Y,{get when(){return ys.has(e.z.toolType())},get children(){var u=xs(),h=u.firstChild,$=h.firstChild;return u.style.setProperty("z-index","20"),u.style.setProperty("mix-blend-mode","difference"),h.style.setProperty("stroke","white"),_(y=>{var v=a(),l=2*s()+t()*i(),c=2*s()+t()*d(),g=f(),p=o(),w=`${s()*r()}px`,S=wr(E(e.z).shape);return v!==y.e&&((y.e=v)!=null?u.style.setProperty("transform",v):u.style.removeProperty("transform")),l!==y.t&&k(h,"width",y.t=l),c!==y.a&&k(h,"height",y.a=c),g!==y.o&&k(h,"viewBox",y.o=g),p!==y.i&&((y.i=p)!=null?h.style.setProperty("transform",p):h.style.removeProperty("transform")),w!==y.n&&((y.n=w)!=null?h.style.setProperty("stroke-width",w):h.style.removeProperty("stroke-width")),S!==y.s&&k($,"points",y.s=S),y},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0}),u}}),m(Y,{get when(){return e.z.drawState()?.tool==="spoid"},get children(){var u=Cs(),h=u.firstChild,$=h.nextSibling,y=$.nextSibling;return u.style.setProperty("z-index","21"),u.style.setProperty("width","20rem"),u.style.setProperty("height","20rem"),_(v=>{var l=n()+" translate(-50%, -50%)",c=Z(e.z.drawState().color),g=Z(e.z.drawState().initColor);return l!==v.e&&((v.e=l)!=null?u.style.setProperty("transform",l):u.style.removeProperty("transform")),c!==v.t&&k($,"stroke",v.t=c),g!==v.a&&k(y,"stroke",v.a=g),v},{e:void 0,t:void 0,a:void 0}),u}})]}})]},Ts=e=>bs({captureRef:e.rootRef,onPointerDown(r){},onPointerMove(r){if(r.type!=="T"){const s=ae(e,r.pos);Rr(e,s)}},onPointerUp(r){},onPointerCancel(r){},onDragStart(r){const s=r.pointers.get(r.id);e.config()[s.type==="T"?"canvasTouchAction":"canvasPenAction"]==="draw"&&(Dr(e,ae(e,s.dragStartPos)),ut(e))},onDragMove(r){const s=r.pointers.get(r.id);e.config()[s.type==="T"?"canvasTouchAction":"canvasPenAction"]==="draw"||Ir(e,re(e.angle().cos,-e.angle().sin,1/e.zoom(),s.delta))},onDragEnd(r){const s=r.pointers.get(r.id);e.config()[s.type==="T"?"canvasTouchAction":"canvasPenAction"]==="draw"&&dt(e)},onPinchStart(){Ar(e)},onPinchMove(r){Fr(e),zr(e,r.scale,r.rotate,r.translate),console.log(Ae(e))},onWheel(r){r.preventDefault();const s=ae(e,{x:r.clientX,y:r.clientY});r.ctrlKey||r.metaKey?ue(e,0,1-r.deltaY*.01,s):r.altKey?ue(e,r.deltaY*.01,1,s):e.setScroll(o=>U(o,{x:r.deltaX,y:r.deltaY})),Ae(e)&&Tr(e)}});var Ps=b("<div class=cv-root><div tabindex=-1 class=cv-view><canvas class=cv-pix></canvas><canvas class=cv-pix></canvas><canvas class=cv-pix></canvas><canvas class=cv-pix></canvas><div class=cv-pix>");const Ls=e=>{let t,r;const s=()=>{ps(e.z),r&&requestAnimationFrame(s)};ee(()=>{ls(e.z);const a=Ts(e.z);t=$s(e.z.rootRef,a),r=!0,requestAnimationFrame(s)}),je(()=>{t?.(),r=!1});const o=(a,i,d)=>{const f=e.z.zoom(),u=e.z.size();return{"z-index":`${a}`,top:`${i}px`,left:`${d}px`,width:`${u.width*f}px`,height:`${u.height*f}px`}},n=O(()=>{const a=e.z.scroll();return`translate(${a.x}px, ${a.y}px) rotate(${e.z.angle().rad}rad)`});return(()=>{var a=Ps(),i=a.firstChild,d=i.firstChild,f=d.nextSibling,u=f.nextSibling,h=u.nextSibling,$=h.nextSibling,y=e.z.rootRef;typeof y=="function"?A(y,a):e.z.rootRef=a,i.style.setProperty("transform-origin","0 0"),x(i,m(_s,{get z(){return e.z}}),d);var v=e.z.tempLayerRef;typeof v=="function"?A(v,d):e.z.tempLayerRef=d;var l=e.z.focusedLayerRef;typeof l=="function"?A(l,f):e.z.focusedLayerRef=f;var c=e.z.belowLayerRef;typeof c=="function"?A(c,u):e.z.belowLayerRef=u;var g=e.z.aboveLayerRef;return typeof g=="function"?A(g,h):e.z.aboveLayerRef=h,_(p=>{var w=n(),S=`${e.z.size().width*e.z.zoom()}px`,D=`${e.z.size().height*e.z.zoom()}px`,M=o(6,0,0),C=e.z.size().width,T=e.z.size().height,L={...o(5,0,0),visibility:e.z.showFocusedLayer()?"visible":"hidden"},R=e.z.size().width,B=e.z.size().height,oe=o(4,0,0),ke=e.z.size().width,De=e.z.size().height,pt=o(9,0,0),Re=e.z.size().width,Ie=e.z.size().height,gt={...Le(e.z),...o(1,0,0)};return w!==p.e&&((p.e=w)!=null?i.style.setProperty("transform",w):i.style.removeProperty("transform")),S!==p.t&&((p.t=S)!=null?i.style.setProperty("width",S):i.style.removeProperty("width")),D!==p.a&&((p.a=D)!=null?i.style.setProperty("height",D):i.style.removeProperty("height")),p.o=j(d,M,p.o),C!==p.i&&k(d,"width",p.i=C),T!==p.n&&k(d,"height",p.n=T),p.s=j(f,L,p.s),R!==p.h&&k(f,"width",p.h=R),B!==p.r&&k(f,"height",p.r=B),p.d=j(u,oe,p.d),ke!==p.l&&k(u,"width",p.l=ke),De!==p.u&&k(u,"height",p.u=De),p.c=j(h,pt,p.c),Re!==p.w&&k(h,"width",p.w=Re),Ie!==p.m&&k(h,"height",p.m=Ie),p.f=j($,gt,p.f),p},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0}),a})()};var Ms=b("<button>");const G=e=>{const t=ve({class:""},e),[r,s]=Ve(t,["class"]);let o;const n={pointerdown:a=>{t.onActive?.(),a.preventDefault(),o.setPointerCapture(a.pointerId)},pointerup:a=>{t.onDeactive?.(),o.releasePointerCapture(a.pointerId)},pointerleave:a=>{t.onDeactive?.(),o.releasePointerCapture(a.pointerId)}};return ee(()=>{for(const[a,i]of Object.entries(n))o.addEventListener(a,i)}),je(()=>{for(const[a,i]of Object.entries(n))o.removeEventListener(a,i)}),(()=>{var a=Ms(),i=o;return typeof i=="function"?A(i,a):o=a,qe(a,ve({get class(){return`p-tool-btn ${r.class}`}},s),!1,!1),a})()},we={free:kt,rect:Ke,fillRect:Dt,fillEllipse:Rt,line:It,fill:Bt},Ue={brush:Et,eraser:Ot,spoid:At,transform:Ft,select:Xe,deselect:zt,text:Ht};var ks=b('<div class=p-tool-panel><div class="p-tool-row p-tr-util"></div><div class="p-tool-row p-tr-util"><div class=p-tool-color-preview><div></div></div></div><div class="p-tool-row p-tr-draw"></div><div class="p-tool-row p-tr-dot"><button class="p-tool-btn p-dot-btn"> DOT');const Ds=e=>{const t=o=>{const n=e.z.toolType();o===n?e.sw.brush(!0):Pr(e.z,o)},r=o=>()=>{e.sw[o](!0)},s=Object.keys(Ue);return(()=>{var o=ks(),n=o.firstChild,a=n.nextSibling,i=a.firstChild,d=i.firstChild,f=a.nextSibling,u=f.nextSibling,h=u.firstChild,$=h.firstChild;return x(n,m(G,{get onClick(){return r("view")},get children(){return m(Nt,{})}}),null),x(n,m(G,{get onClick(){return r("layers")},get children(){return m(Gt,{})}}),null),x(n,m(G,{get onClick(){return r("settings")},get children(){return m(Ut,{})}}),null),yt(i,"click",r("palette"),!0),x(a,m(G,{get onClick(){return r("drawShape")},get children(){return m(Q,{get component(){return we[e.z.drawShape()]}})}}),null),x(a,m(G,{get children(){return m(Xe,{})}}),null),x(a,m(G,{onClick:()=>ds(e.z),get disabled(){return e.z.history.historySize()[0]<=0},get children(){return m(jt,{})}}),null),x(a,m(G,{onClick:()=>hs(e.z),get disabled(){return e.z.history.historySize()[1]<=0},get children(){return m(Vt,{})}}),null),x(f,m(te,{each:s,children:y=>m(G,{get class(){return e.z.toolType()===y?"active":""},onClick:()=>t(y),get children(){return m(Q,{get component(){return Ue[y]}})}})})),u.$$pointerup=y=>{y.currentTarget.releasePointerCapture(y.pointerId),dt(e.z)},u.$$pointerdown=y=>{y.preventDefault(),y.currentTarget.setPointerCapture(y.pointerId),ut(e.z)},x(h,m(qt,{}),$),_(y=>{var v={"border-color":e.z.palette().hsv[2]>.5?"black":"white",...Le(e.z)},l=Z(e.z.palette().current);return y.e=j(i,v,y.e),l!==y.t&&((y.t=l)!=null?d.style.setProperty("background",l):d.style.removeProperty("background")),y},{e:void 0,t:void 0}),o})()};N(["click","pointerdown","pointerup"]);var Rs=b("<div>");const ht=e=>{const[t,r]=Ve(e,["checked","onChange","class"]);let s;return ee(()=>{s.addEventListener("click",()=>{t.onChange?.(!t.checked)})}),(()=>{var o=Rs(),n=s;return typeof n=="function"?A(n,o):s=o,qe(o,ve(r,{get class(){return`-d-ckbox ${t.class||""}`},tabIndex:-1}),!1,!0),x(o,m(be,{get children(){return[m(Y,{get when(){return t.checked},get children(){return m(Yt,{})}}),m(Y,{get when(){return!t.checked},get children(){return m(Ke,{})}})]}})),o})()};var Is=b("<div class=pam-item><span class=label> Brush Size </span><input type=number>"),Bs=b("<input type=range min=1 max=20>"),Es=b("<hr>"),Os=b("<label class=pam-item><span class=label> Round Brush "),As=b("<label class=pam-item><span class=label> Local "),Fs=b("<label class=pam-item><span class=label> Font Size </span><select>"),zs=b("<label class=pam-item><span class=label> Text </span><input type=text>"),Hs=b("<option>"),Ns=b("<div class=pa-modal-title>Brush (<!>)");const Gs=e=>{const t=()=>E(e.z),[r,s]=P(t().size),[o,n]=P(t().round),a=()=>{Lr(e.z,r(),o())},i=()=>{n(d=>!d),a()};return[(()=>{var d=Is(),f=d.firstChild,u=f.nextSibling;return u.$$input=h=>{s(parseInt(h.target.value)),a()},_(()=>u.value=t().size),d})(),(()=>{var d=Bs();return d.$$input=f=>{s(parseInt(f.target.value)),a()},_(()=>d.value=r()),d})(),Es(),(()=>{var d=Os();return d.firstChild,d.$$click=i,x(d,m(ht,{get checked(){return o()}}),null),d})()]},Us=e=>{const t=()=>E(e.z),r=()=>{Cr(e.z,e.z.toolType(),!t().spoidLocal)};return(()=>{var s=As();return s.firstChild,s.$$click=r,x(s,m(ht,{get checked(){return t().spoidLocal}}),null),s})()},js=e=>{const t=()=>E(e.z),r=[8,10,12],s=n=>{const a=n.target.value;Oe(e.z,e.z.toolType(),void 0,parseInt(a))},o=n=>{const a=n.target.value;Oe(e.z,e.z.toolType(),a)};return[(()=>{var n=Fs(),a=n.firstChild,i=a.nextSibling;return i.addEventListener("change",s),x(i,m(te,{each:r,children:d=>(()=>{var f=Hs();return f.value=d,x(f,d),_(()=>f.selected=t().fontSize===d),f})()})),n})(),(()=>{var n=zs(),a=n.firstChild,i=a.nextSibling;return i.addEventListener("change",o),_(()=>i.value=t().text??""),n})()]},Vs=e=>{const t=()=>e.z.toolType();return[(()=>{var r=Ns(),s=r.firstChild,o=s.nextSibling;return o.nextSibling,x(r,t,o),r})(),m(be,{get children(){return[m(Y,{get when(){return t()==="brush"||t()==="eraser"},get children(){return m(Gs,e)}}),m(Y,{get when(){return t()==="spoid"},get children(){return m(Us,e)}}),m(Y,{get when(){return t()==="text"},get children(){return m(js,e)}})]}})]};N(["input","click"]);var qs=b("<div class=pa-modal-title>Draw Shape"),Ys=b("<div><span class=label>");const Zs=e=>{const t=Object.keys(we);return[qs(),m(te,{each:t,children:r=>(()=>{var s=Ys(),o=s.firstChild;return s.$$click=()=>e.z.setDrawShape(r),x(o,r),x(s,m(Q,{get component(){return we[r]}}),null),_(()=>$e(s,`pam-item ${e.z.drawShape()===r?"selected":""}`)),s})()})]};N(["click"]);var Ks=b("<div><canvas class=pam-layer-preview>"),Xs=b("<div class=pa-modal-title>Layers<div><button></button><button></button><button>"),Ws=b('<div class="pam-dragging sortable pam-item">');const Js=e=>{let t;const r=sr(e.l.id);or();const s=()=>e.z.focusedLayer()===e.idx,o=n=>{Xr(e.z,n)};return ee(()=>{const n=e.z.focusedLayer(),a=t.getContext("2d"),i=e.idx===n?F(e.z):e.l.data;a.canvas.width=i.canvas.width,a.canvas.height=i.canvas.height,a.drawImage(i.canvas,0,0)}),(()=>{var n=Ks(),a=n.firstChild;n.$$click=()=>o(e.idx),A(r,n,()=>!0);var i=t;return typeof i=="function"?A(i,a):t=a,x(n,()=>e.l.name,null),_(d=>{var f=`${`sortable pam-item pam-layer ${s()?"selected":""}`||""} transition-transform`,u=!!r.isActiveDraggable,h={...Le(e.z)};return f!==d.e&&$e(n,d.e=f),u!==d.t&&n.classList.toggle("opacity-25",d.t=u),d.a=j(a,h,d.a),d},{e:void 0,t:void 0,a:void 0}),n})()},Qs=e=>{const t=()=>{const h=e.z.layers(),$=new Set(h.map(l=>l.name));let y=h.length,v=`Layer ${y}`;for(;$.has(v);)v=`Layer ${++y}`;Zr(e.z,v)},r=()=>{const h=e.z.focusedLayer();Kr(e.z,h)},s=()=>{},o=O(()=>e.z.layers().map((h,$)=>[$,h]).reverse()),n=h=>{h.reverse();const $=e.z.focusedLayer();let y=null;e.z.setLayers(v=>{const l=new Map;return v.forEach(g=>l.set(g.id,g)),y=h.indexOf(v[$].id),h.map(g=>l.get(g))}),e.z.setFocusedLayer(y)},a=()=>o().map(h=>h[1].id),[i,d]=P(null),f=({draggable:h})=>d(h.id),u=({draggable:h,droppable:$})=>{if(h&&$){const y=a(),v=y.indexOf(h.id),l=y.indexOf($.id);if(v!==l){const c=y.slice();c.splice(l,0,...c.splice(v,1)),console.log(c),n(c)}}};return[(()=>{var h=Xs(),$=h.firstChild,y=$.nextSibling,v=y.firstChild,l=v.nextSibling,c=l.nextSibling;return v.$$click=r,x(v,m(Zt,{})),l.$$click=s,x(l,m(Kt,{})),c.$$click=t,x(c,m(Xt,{})),h})(),m(rr,{onDragStart:f,onDragEnd:u,collisionDetector:Jt,get children(){return[m(Qt,{}),m(er,{get ids(){return a()},get children(){return m(te,{get each(){return o()},children:([h,$])=>m(Js,{get z(){return e.z},l:$,idx:h})})}}),m(tr,{style:{"z-index":"200"},get children(){var h=Ws();return x(h,i),h}})]}})]};N(["click"]);var eo=b("<div><div class=pa-modal-content>");const to=e=>{const t=r=>{r.target===r.currentTarget&&e.onClose()};return(()=>{var r=eo(),s=r.firstChild;return r.$$click=t,x(s,()=>e.children),_(()=>$e(r,"pa-modal-ext "+e.position)),r})()};N(["click"]);var ro=b("<div class=pa-modal-title>Palette<span class=p-tool-color-preview>"),so=b("<div class=pa-color-picker>"),ne=b("<hr>"),oo=b("<div class=pa-color-sliders><div> RGB </div><div class=pa-color-slider-line><span>R:</span><input type=text readonly></div><div class=pa-color-slider-line><span>G:</span><input type=text readonly></div><div class=pa-color-slider-line><span>B:</span><input type=text readonly></div><div class=pa-color-slider-line><span>A:</span><input type=text readonly>"),no=b("<div class=pa-color-sliders><div> HSV </div><div class=pa-color-slider-line><span>H:</span><input type=text readonly></div><div class=pa-color-slider-line><span>S:</span><input type=text readonly></div><div class=pa-color-slider-line><span>V:</span><input type=text readonly>"),ao=b("<div class=pa-color-value><div class=pa-color-slider-line><span> Hex RGB </span><input type=text readonly>"),io=b("<div> Last Used Colors "),lo=b("<div class=pa-palette>"),co=b("<div class=pa-palette-color><div class=abs-0>");const uo=e=>{const t=()=>e.z.palette(),r=O(()=>{const c=[...e.z.palette().history];return c.reverse(),c});let s,o=t().hsv,n=t().current[3]/255;const a=()=>{s!==void 0&&clearTimeout(s),s=setTimeout(()=>{s=void 0,jr(e.z,o,n*255)},500)},[i,d]=P(o),f=l=>{d(l),o=l,a()},[u,h]=P(n),$=l=>{h(l),n=l,a()},y=()=>"#"+J(i()).map(c=>Math.floor(c).toString(16).padStart(2,"0")).join(""),v=(l,c)=>{d(Ze([c[0],c[1],c[2]])),it(e.z,c)};return[(()=>{var l=ro(),c=l.firstChild,g=c.nextSibling;return g.style.setProperty("display","inline-block"),g.style.setProperty("width","1.5em"),g.style.setProperty("height","1em"),g.style.setProperty("vertical-align","bottom"),g.style.setProperty("margin","0 0.5em"),_(p=>{var w=bt(i()),S=i()[2]>.5?"black":"white";return w!==p.e&&((p.e=w)!=null?g.style.setProperty("background",w):g.style.removeProperty("background")),S!==p.t&&((p.t=S)!=null?g.style.setProperty("border-color",S):g.style.removeProperty("border-color")),p},{e:void 0,t:void 0}),l})(),(()=>{var l=so();return x(l,m($t,{class:"wheel",get hsv(){return i()},onHSVChange:f,strokeWidth:.25,rotate:!0})),l})(),ne(),(()=>{var l=oo(),c=l.firstChild,g=c.nextSibling,p=g.firstChild,w=p.nextSibling,S=g.nextSibling,D=S.firstChild,M=D.nextSibling,C=S.nextSibling,T=C.firstChild,L=T.nextSibling,R=C.nextSibling,B=R.firstChild,oe=B.nextSibling;return x(g,m(St,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),w),x(S,m(xt,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),M),x(C,m(Ct,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),L),x(R,m(_t,{class:"pa-color-slider",get hsv(){return i()},get alpha(){return u()},onAlphaChange:$}),oe),_(()=>w.value=Math.floor(J(i())[0])),_(()=>M.value=Math.floor(J(i())[1])),_(()=>L.value=Math.floor(J(i())[2])),_(()=>oe.value=u().toFixed(2)),l})(),ne(),(()=>{var l=no(),c=l.firstChild,g=c.nextSibling,p=g.firstChild,w=p.nextSibling,S=g.nextSibling,D=S.firstChild,M=D.nextSibling,C=S.nextSibling,T=C.firstChild,L=T.nextSibling;return x(g,m(Tt,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),w),x(S,m(Pt,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),M),x(C,m(Lt,{class:"pa-color-slider",get hsv(){return i()},onHSVChange:f}),L),_(()=>w.value=Math.floor(i()[0])),_(()=>M.value=Math.floor(i()[1]*100)),_(()=>L.value=Math.floor(i()[2]*100)),l})(),ne(),(()=>{var l=ao(),c=l.firstChild,g=c.firstChild,p=g.nextSibling;return _(()=>p.value=y()),l})(),ne(),io(),(()=>{var l=lo();return x(l,m(vt,{get each(){return r()},children:(c,g)=>(()=>{var p=co(),w=p.firstChild;return p.$$click=()=>v(g,c()),_(S=>{var D={...Ye("#aaa","#777",16)},M=Z(c());return S.e=j(p,D,S.e),M!==S.t&&((S.t=M)!=null?w.style.setProperty("background",M):w.style.removeProperty("background")),S},{e:void 0,t:void 0}),p})()})),l})()]};N(["click"]);const ho=0,fo=async e=>{const t=[];for(const r of e.layers()){const s=await cr(r.data);t.push({...r,data:s,size:lr(r.data)})}return t},po=async e=>{he(e);const t=await fo(e);return{version:ho,name:e.name,size:e.size(),layers:t}},go=async(e,t)=>{const r=[];for(const s of t.layers)r.push(await ur(s.data));H(()=>{e.name=t.name,e.setSize(t.size);const s=[];r.forEach((o,n)=>{const a={...t.layers[n],data:o};s.push(a)}),e.setLayers(s)})};var yo=b("<div class=pa-modal-title>Settings / Files"),vo=b("<div> About "),mo=b("<a class=pam-item href=https://github.com/lumiknit/dubu-tl><span>https://github.com/lumiknit/dubu-tl"),wo=b("<div> File "),bo=b("<div class=pam-item>Save temp"),$o=b("<div class=pam-item>Load temp"),So=b("<div> Other "),xo=b("<div class=pam-item>Fullscreen"),Co=b("<div class=pam-item>Reset Zoom"),_o=b("<div> Files "),To=b("<div class=pam-item>Export"),Po=b("<div class=pam-item><span class=label>Import image </span><input type=file accept=image/*>"),Lo=b("<hr>"),Mo=b("<h3> Change Canvas Size "),ko=b("<div class=pam-item><span class=label> Width </span><input type=number>"),Do=b("<div class=pam-item><span class=label> Height </span><input type=number>"),Ro=b("<div class=pam-item><button> Change ");const Io=e=>{let t,r;const s=i=>{const f=i.target.files?.[0];if(console.log(f),!f)return;const u=new FileReader;u.onload=()=>{const h=new Image;h.onload=()=>{const $=e.z.focusedLayerRef.getContext("2d");$&&$.drawImage(h,0,0)},h.src=u.result},u.readAsDataURL(f)},o=async()=>{he(e.z);const i=await po(e.z);localStorage.setItem("dubu-temp",JSON.stringify(i)),I.success("Saved temp")},n=async()=>{const i=localStorage.getItem("dubu-temp");if(console.log(i),!i){I.error("No temp data");return}let d;try{d=JSON.parse(i)}catch{I.error("Temp data was corrupted");return}await go(e.z,d),fe(e.z),I.success("Loaded temp")},a=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()};return[yo(),vo(),(()=>{var i=mo(),d=i.firstChild,f=d.firstChild;return x(d,m(Wt,{}),f),i})(),wo(),(()=>{var i=bo();return i.$$click=o,i})(),(()=>{var i=$o();return i.$$click=n,i})(),So(),(()=>{var i=xo();return i.$$click=a,i})(),(()=>{var i=Co();return i.$$click=()=>{ct(e.z)},i})(),_o(),(()=>{var i=To();return i.$$click=()=>{const d=Nr(e.z,4);Je(d).then(u=>{const h=URL.createObjectURL(u),$=document.createElement("a");$.href=h,$.download="image.png",$.click(),URL.revokeObjectURL(h)})},i})(),(()=>{var i=Po(),d=i.firstChild,f=d.nextSibling;return f.$$input=s,i})(),Lo(),Mo(),(()=>{var i=ko(),d=i.firstChild,f=d.nextSibling,u=t;return typeof u=="function"?A(u,f):t=f,_(()=>f.value=e.z.size().width),i})(),(()=>{var i=Do(),d=i.firstChild,f=d.nextSibling,u=r;return typeof u=="function"?A(u,f):r=f,_(()=>f.value=e.z.size().height),i})(),(()=>{var i=Ro(),d=i.firstChild;return d.$$click=()=>{const f=Number(t.value),u=Number(r.value);if(isNaN(f)||isNaN(u)||f<=0||u<=0){I.error("Invalid size");return}fs(e.z,[{type:"changeCanvasSize",next:{width:f,height:u}}])},i})()]};N(["click","input"]);var Bo=b("<div class=pa-modal-title>View"),Eo=b("<div class=pam-item><span class=label> Zoom </span><input type=number>"),Oo=b("<input type=range min=-4 max=10 step=0.25>"),Ao=b("<div class=pam-item><span class=label> Rotate </span><input type=number>"),Fo=b("<input type=range step=0.01>");const zo=e=>[Bo(),(()=>{var t=Eo(),r=t.firstChild,s=r.nextSibling;return _(()=>s.value=Math.floor(e.z.zoom()*100)),t})(),(()=>{var t=Oo();return t.$$input=r=>{let o=2**+r.currentTarget.value;Math.abs(o-Math.round(o))<.25&&(o=Math.round(o)),ue(e.z,0,o/e.z.zoom())},_(()=>t.value=Math.log2(e.z.zoom())),t})(),(()=>{var t=Ao(),r=t.firstChild,s=r.nextSibling;return _(()=>s.value=Math.round(e.z.angle().rad*(180/Math.PI))),t})(),(()=>{var t=Fo();return t.$$input=r=>{let s=+r.currentTarget.value*(180/Math.PI);Math.abs(s-Math.round(s/15)*15)<3&&(s=Math.round(s/15)*15),ue(e.z,s*(Math.PI/180)-e.z.angle().rad,1)},_(r=>{var s=-Math.PI,o=Math.PI;return s!==r.e&&k(t,"min",r.e=s),o!==r.t&&k(t,"max",r.t=o),r},{e:void 0,t:void 0}),_(()=>t.value=e.z.angle().rad),t})()];N(["input"]);const Ho=e=>{const[t,r]=P(!1),s={show:t,setShow:r,position:e};return o=>typeof o=="boolean"?(r(o),o&&s.position):(o&&(s.position=o),t()&&s.position)},ft=[{type:"palette",position:"left",component:uo},{type:"brush",position:"left",component:Vs},{type:"drawShape",position:"left",component:Zs},{type:"layers",position:"right",component:Qs},{type:"settings",position:"right",component:Io},{type:"view",position:"center",component:zo}],No=()=>{const e={};for(const t of ft)e[t.type]=Ho(t.position);return e},Go=e=>m(te,{each:ft,children:t=>m(mt,{get when(){return e.switches[t.type]()},get children(){return m(to,{get position(){return e.switches[t.type]()},onClose:()=>e.switches[t.type](!1),get children(){return m(Q,{get component(){return t.component},get z(){return e.z}})}})}})});var Uo=b("<div class=p-edit-view><div class=p-paint-area>");const jo=()=>{let t=is({brushStabilization:5},128,128),r=No();return(()=>{var s=Uo(),o=s.firstChild;return x(o,m(Ls,{z:t})),x(s,m(Ds,{z:t,sw:r}),null),x(s,m(Go,{switches:r,z:t}),null),s})()},Vo={gallery:ar,edit:jo},qo=e=>{const[t,r]=P(e);return{current:t,setCurrent:r}},Yo=e=>m(Q,{get component(){return Vo[e.z.current()]},changePage:t=>{e.z.setCurrent(t)}});var Zo=b("<div class=app>");const Ko=()=>{const e=qo("edit");return(()=>{var t=Zo();return x(t,m(Mt,{position:"top-center"}),null),x(t,m(Yo,{z:e}),null),t})()},Xo=document.getElementById("root");wt(()=>m(Ko,{}),Xo);
